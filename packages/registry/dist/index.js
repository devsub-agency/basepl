#!/usr/bin/env node
import{Command as Ne}from"commander";var F={name:"@basepl/cli",version:"1.0.0",description:"Add fields and blocks to your payload cms.",publishConfig:{access:"public"},license:"MIT",author:{name:"devsub",url:"https://devsub.de/en"},repository:{type:"git",url:"https://github.com/devsub-agency/payloadbase",directory:"templates"},files:["dist"],keywords:["payload","components","fields","blocks"],type:"module",bin:{basepl:"./dist/index.js"},exports:{".":{import:"./dist/index.js"}},scripts:{dev:"tsup --watch",build:"tsup",typecheck:"tsc --noEmit",clean:"rimraf dist node_modules","start:dev":"cross-env REGISTRY_URL=http://localhost:3333/r node dist/index.js","start:prod":"cross-env REGISTRY_URL=https://ui.shadcn.com/r node dist/index.js",start:"node dist/index.js","format:write":'prettier --write "**/*.{ts,tsx,mdx}" --cache',"format:check":'prettier --check "**/*.{ts,tsx,mdx}" --cache',release:"changeset version","pub:beta":"pnpm build && pnpm publish --no-git-checks --access public --tag beta","pub:next":"pnpm build && pnpm publish --no-git-checks --access public --tag next","pub:release":"pnpm build && pnpm publish --access public",test:"vitest run","test:dev":"REGISTRY_URL=http://localhost:3333/r vitest run"},dependencies:{chalk:"^5.3.0",commander:"^12.1.0",cosmiconfig:"^9.0.0",diff:"^7.0.0",execa:"^9.5.1","fast-glob":"^3.3.2","fs-extra":"^11.2.0",kleur:"^4.1.5","node-fetch":"^3.3.2",ora:"^8.1.1",prompts:"^2.4.2","ts-morph":"^24.0.0","tsconfig-paths":"^4.2.0",zod:"^3.23.8"},devDependencies:{"@types/fs-extra":"^11.0.4","@types/lodash.template":"^4.5.3","@types/prompts":"^2.4.9",tsup:"8.3.5","type-fest":"^4.29.0",typescript:"^5.7.2",rimraf:"^5.0.0"}};import{Command as $e}from"commander";import ze from"path";import{z as u}from"zod";import{red as se,white as ae,green as ce,yellow as pe}from"kleur/colors";var c={error:se,warn:pe,info:ae,success:ce},r={error(...e){console.log(c.error(e.join(" ")))},warn(...e){console.log(c.warn(e.join(" ")))},info(...e){console.log(c.info(e.join(" ")))},success(...e){console.log(c.success(e.join(" ")))},log(...e){console.log(e.join(" "))},break(){console.log("")}};import{z as b}from"zod";import{z as p}from"zod";var w=p.enum(["templates/fields","templates/blocks","templates/components"]),le=p.object({path:p.string(),content:p.string().optional(),type:w}),$=p.object({name:p.string(),type:w,files:p.array(le)}),de=p.object({path:p.string(),type:w}),me=p.object({name:p.string(),type:w,dependencies:p.array(p.string()).optional(),registryDependencies:p.array(p.string()).optional(),files:p.array(de)}),x=p.array(me);var fe=b.object({found:b.array(x.element),notFound:b.array(b.string())}),z=(e,t)=>{let o=fe.parse({found:[],notFound:[]});return t.forEach(i=>{let n=e.find(s=>s.name.toLowerCase()===i.toLowerCase());n?o.found.push(n):o.notFound.push(i)}),o};import D from"path";import{z as ge}from"zod";var ue=e=>{if(r.error("Something went wrong. Please check the error below for more details."),r.error("If the problem persists, please open an issue on GitHub."),r.error(""),typeof e=="string"&&(r.error(e),r.break(),process.exit(1)),e instanceof ge.ZodError){r.error("Validation failed:");for(let[t,o]of Object.entries(e.flatten().fieldErrors))r.error(`- ${c.info(t)}: ${o}`);r.break(),process.exit(1)}e instanceof Error&&(r.error(e.message),r.break(),process.exit(1)),r.break(),process.exit(1)},d=ue;var ye="http://localhost:3000/registry",O=async()=>{try{let e=await v("index.json");return x.parse(e)}catch(e){r.error(`
`),d(e)}},v=async e=>{try{let t=await fetch(he(e));if(!t.ok)throw new Error(`Failed to fetch registry: ${t.statusText}`);return t.json()}catch(t){return r.error(`
`),d(t),null}},he=e=>(e.endsWith(".json")||(e=we(e)),`${ye}/${e}`),we=e=>{if(e.endsWith(".json"))return e;let t=D.parse(e);return D.format({...t,base:void 0,ext:".json"})};var E=async(e,t)=>{let o=new Set,i=[],n=s=>{o.has(s.name)||(o.add(s.name),s.registryDependencies?.length&&s.registryDependencies.forEach(a=>{let l=t.find(m=>m.name===a);l&&n(l)}),i.push(s))};return e.forEach(s=>n(s)),i};import be from"path";import k from"fs-extra";import{execa as M}from"execa";async function S(e){let{options:t,projectDir:o}=e;try{let n="npm";return t?.pnpm||k.existsSync(`${o}/pnpm-lock.yaml`)?n="pnpm":t?.yarn||k.existsSync(`${o}/yarn.lock`)?n="yarn":t?.npm||k.existsSync(`${o}/package-lock.json`)?n="npm":t?.bun||k.existsSync(`${o}/bun.lockb`)?n="bun":await i("pnpm")&&(n="pnpm"),n}catch{return"npm"}async function i(n){try{return process.platform==="win32"?await M`where ${n}`:await M`command -v ${n}`,!0}catch{return!1}}}import xe from"ora";function g(e,t){return xe({text:e,isSilent:t?.silent})}import ke from"fs-extra";import Se from"prompts";import{execa as Ie}from"execa";var U=async(e,t)=>{if(!t?.length)return;let o=g("Installing dependencies.").start(),i=await S({options:null,projectDir:e}),n="";if(je(e)&&i==="npm"){o.stopAndPersist(),r.warn(`
It looks like you are using React 19. 
Some packages may fail to install due to peer dependency issues in npm (see https://ui.shadcn.com/react-19).
`);let s=await Se([{type:"select",name:"flag",message:"How would you like to proceed?",choices:[{title:"Use --force",value:"force"},{title:"Use --legacy-peer-deps",value:"legacy-peer-deps"}]}]);s&&(n=s.flag)}o?.start(),await Ie(i,[i==="npm"?"install":"add",...i==="npm"&&n?[`--${n}`]:[],...t],{cwd:e}),o?.succeed()},je=e=>{let t=be.join(e,"package.json"),o=ke.readJSONSync(t,{throws:!0});return o?.dependencies?.react?/^(?:\^|~)?19(?:\.\d+)*(?:-.*)?$/.test(o.dependencies.react):!1};import{existsSync as A,promises as T}from"fs";import I,{basename as J,dirname as Pe}from"path";import ve from"prompts";var Re=async e=>{try{r.info(`
 Reading template: ${e.path}`);let t=await v(e.path);return $.parse(t).files[0].content||""}catch(t){return r.error(`Failed to read template: ${e.path}`),d(t),""}},N=async(e,t)=>{if(!t?.length)return;let o=[],i=[],n=[],s=g("Adding files change ...").start();try{for(let a of t){let l=J(a.path),m=I.join(e.cwd,"src",a.path).replace(l,""),y=I.join(m,l);if(r.warn(`
Adding file ${c.info(l)} to ${c.info(m)} resulting in path ${c.info(y)}`),A(y)&&!e.overwrite){s.stop();let{overwrite:ne}=await ve({type:"confirm",name:"overwrite",message:`File ${c.info(J(a.path))} exists. Overwrite?`,initial:!1});if(!ne){n.push(I.relative(e.cwd,y)),s.start();continue}s.start()}await T.mkdir(m,{recursive:!0});let re=await Re(a);await T.writeFile(y,re,"utf-8");let P=I.relative(e.cwd,y);r.info(`File ${c.info(l)} added to ${c.info(Pe(P))}`),A(y)?i.push(P):o.push(P)}s.succeed("Files added successfully"),o.length&&r.info(`Created files:
`+o.map(a=>`  ${a}`).join(`
`)),i.length&&r.info(`Updated files:
`+i.map(a=>`  ${a}`).join(`
`)),n.length&&r.info(`Skipped files:
`+n.map(a=>`  ${a}`).join(`
`))}catch(a){s.fail("Failed to add files"),d(a)}};var _=async(e,t)=>{let o=await O();o||(r.error("Failed to fetch registry"),process.exit(1));let{found:i,notFound:n}=z(o,e);n.length>0&&(r.warn(`Components not found in registry: ${n.join(", ")}`),i.length===0&&(r.error("No valid components to install"),process.exit(1)));let s=await E(i,o);await U(t.cwd,s.flatMap(a=>a.dependencies?.filter(l=>l!==void 0)??[])),await N({cwd:t.cwd,overwrite:t.overwrite},s.flatMap(a=>a.files))};import L from"path";import G from"fs-extra";var h=".payloadbase.json",V=async(e,t)=>{let o={version:"1.0.0",initialized:!0,timestamp:new Date().toISOString(),shadcnInstalled:!1,...t};await G.writeJSON(L.join(e,h),o,{spaces:2})},Ce=async e=>{try{return await G.readJSON(L.join(e,h))}catch{return null}},W=async e=>!!(await Ce(e))?.initialized,Y={version:"1.0.0",initialized:!0,timestamp:new Date().toISOString(),shadcnInstalled:!1};import{existsSync as H}from"fs";import Fe from"path";var q=e=>{(!H(e.cwd)||!H(Fe.resolve(e.cwd,"package.json")))&&(r.error("Target project does not exist or is not a valid Payload project"),process.exit(0))};var De=u.object({components:u.array(u.string()).optional(),yes:u.boolean(),overwrite:u.boolean(),cwd:u.string(),config:u.boolean()}),Oe=new $e("add").description("add fields and blocks to your payload cms project").argument("[components...]","the fields and blocks to add.").option("-y, --yes","skip confirmation prompt.",!0).option("-o, --overwrite","overwrite existing files.",!1).option("-c, --cwd <cwd>","the working directory. defaults to the current directory.",process.cwd()).option("--config","only add the config.ts without component",!1).action(async(e,t)=>{try{let o=De.parse({components:e,cwd:ze.resolve(t.cwd),...t});await W(o.cwd)||(r.error("Project is not initialized. Please run 'payloadbase init' first"),process.exit(0)),o.components?.length||(r.error("Provide at least one field or block to install!"),process.exit(0)),q(o),await _(o.components,o)}catch(o){r.error("An error occurred while adding the field:",o),process.exit(1)}}),B=Oe;import{Command as Te}from"commander";import te from"prompts";import{z as f}from"zod";import{execa as Ee}from"execa";async function Z({cwd:e,packageManager:t}){try{let o=t==="npm"?["npx","shadcn@latest","init"]:[t,"dlx","shadcn@latest","init"];await Ee(o[0],o.slice(1),{cwd:e,stdio:"inherit",shell:!0})}catch(o){d(o)}}import{existsSync as C}from"fs";import Me from"fs-extra";import j from"path";var K=3,Ue=["latest"];var Q=async e=>C(j.resolve(e,"src/payload.config.ts")),X=async e=>C(j.resolve(e,"components.json")),ee=async e=>{let t=C(j.resolve(e,"src")),i=(await Me.readJson(j.resolve(e,"package.json"))).dependencies?.payload??null;if(!i)return R(t,!1,null);let n=i.match(/^(?:(?<major>\d+)|(?<special>latest|beta))$/i);if(!n)return r.warn(`Could not determine payload version from ${i}`),R(t,!1,i);let{special:s,major:a}=n.groups,l=Ae(s,a);return l||r.warn(`Unsupported payload version ${i}. Version must be latest or >= ${K}.0.0`),R(t,l,i)},Ae=(e,t)=>e?Ue.includes(e.toLowerCase()):t?parseInt(t)>=K:!1,R=(e,t,o)=>({isSrcDir:e,isSupportedPayloadVersion:t,payloadVersion:o});var Je=f.object({cwd:f.string(),yes:f.boolean(),defaults:f.boolean(),npm:f.boolean().optional(),bun:f.boolean().optional(),yarn:f.boolean().optional(),pnpm:f.boolean().optional()}),oe=new Te().name("init").description("Initialize your project and install dependencies.").option("-c, --cwd <cwd>","the working directory. defaults to the current directory.",process.cwd()).option("-y, --yes","skip confirmation prompt.",!0).option("-d, --defaults,","use default configuration.",!1).option("--npm,","use npm to install dependencies",!1).option("--bun,","use npm to install dependencies",!1).option("--yarn,","use npm to install dependencies",!1).option("--pnpm,","use npm to install dependencies",!1).action(async e=>{try{let t=Je.parse(e),o=g("Checking project setup.").start();await Q(t.cwd)||(o.fail(),r.error("Payload is not present in the project."),r.warn(`Please init the project with payload first. Use ${c.success("'npx create-payload-app'")} or check out the official payload documentation.`),process.exit(0)),o.succeed(),(await ee(t.cwd)).isSupportedPayloadVersion||process.exit(0);let s=await S({options:t,projectDir:t.cwd});if(await X(t.cwd))r.info("Shadcn is already present in the project.");else{if(r.info("Shadcn is not present in the project."),!t.yes){let{proceed:m}=await te({type:"confirm",name:"proceed",message:"Do you want to install shadcn/ui in the project?",initial:!0});m||process.exit(0)}await Z({cwd:t.cwd,packageManager:s})}if(!t.yes){let{proceed:m}=await te({type:"confirm",name:"proceed",message:`Write configuration to ${c.info(`${h}`)}. Proceed?`,initial:!0});m||process.exit(0)}let l=g(`Writing ${h}.`).start();await V(t.cwd,{...Y,shadcnInstalled:!0}),l.succeed(),r.success("Project is ready to install components!"),r.info(`Use ${c.success("'add <component>'")} to install components. For a list of available components and for further information check the documentation.`)}catch(t){r.break(),d(t)}});process.on("SIGINT",()=>process.exit(0));process.on("SIGTERM",()=>process.exit(0));async function _e(){let e=new Ne().name("basepl").description("add fields and blocks to your payload cms project").version(F.version||"1.0.0","-v, --version","display the version number");e.addCommand(B).addCommand(oe),e.parse()}_e();
//# sourceMappingURL=index.js.map